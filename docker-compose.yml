version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: terra-bud-app
    ports:
      - "8080:8080"
    environment:
      # GitHub OAuth Configuration
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
      - GITHUB_REDIRECT_URI=${GITHUB_REDIRECT_URI:-http://localhost:8080/auth/callback}
      
      # Session Configuration
      - SESSION_SECRET=${SESSION_SECRET:-super-secret-string-change-in-production}
      
      # Mistral AI Configuration
      - MISTRAL_API_KEY=${MISTRAL_API_KEY}
      - MISTRAL_MODEL=${MISTRAL_MODEL:-mistral-large-latest}
      - MISTRAL_API_BASE_URL=${MISTRAL_API_BASE_URL:-https://api.mistral.ai/v1}
      - MISTRAL_TIMEOUT=${MISTRAL_TIMEOUT:-120}
      - MISTRAL_MAX_TOKENS=${MISTRAL_MAX_TOKENS:-8192}
      
      # OpenAI Configuration (fallback)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - OPENAI_API_BASE_URL=${OPENAI_API_BASE_URL:-https://api.openai.com/v1}
      - OPENAI_TIMEOUT=${OPENAI_TIMEOUT:-120}
      - OPENAI_MAX_TOKENS=${OPENAI_MAX_TOKENS:-8192}
      
      # Pricing Configuration
      - AWS_PRICING_REGION=${AWS_PRICING_REGION:-us-east-1}
      - PRICING_CACHE_TTL_SECONDS=${PRICING_CACHE_TTL_SECONDS:-86400}
    volumes:
      # Mount pricing cache as volume for persistence and updates
      - ./pricing-cache:/app/pricing-cache
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
